<template>
  <StandardCard
    title="Vulnerability Trends"
    variant="default"
    size="large"
    shadow="sm"
  >
    <template #header-actions>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <!-- Product/Release Filters (Dashboard Only) -->
        <div v-if="showProductFilter && !componentId" class="d-flex align-items-center gap-2 me-3">
          <!-- Product Selector -->
          <div class="filter-group">
            <label class="filter-label">Product:</label>
            <select
              v-model="selectedProductId"
              class="form-select form-select-sm"
              :disabled="isLoadingProducts"
              style="min-width: 150px;"
              @change="handleProductChange(selectedProductId)"
            >
              <option value="">All Products</option>
              <option v-for="product in productsData" :key="product.id" :value="product.id">
                {{ product.name }}
              </option>
            </select>
          </div>

          <!-- Release/Version Selector -->
          <div class="filter-group">
            <label class="filter-label">Version:</label>
            <select
              v-model="selectedReleaseId"
              class="form-select form-select-sm"
              :disabled="!selectedProductId || availableReleases.length === 0"
              style="min-width: 120px;"
              @change="handleReleaseChange(selectedReleaseId)"
            >
              <option value="">All Versions</option>
              <option v-for="release in availableReleases" :key="release.id" :value="release.id">
                {{ release.name }}
                <span v-if="release.is_latest">(Latest)</span>
              </option>
            </select>
          </div>

          <!-- Clear Filters Button -->
          <button
            v-if="selectedProductId || selectedReleaseId"
            class="btn btn-sm btn-outline-secondary"
            title="Clear filters"
            @click="clearFilters"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Time Range Selector -->
        <div class="btn-group btn-group-sm" role="group">
          <button
            v-for="range in timeRanges"
            :key="range.days"
            type="button"
            class="btn"
            :class="selectedDays === range.days ? 'btn-primary' : 'btn-outline-primary'"
            @click="setTimeRange(range.days)"
          >
            {{ range.label }}
          </button>
        </div>

        <!-- Chart Type Selector -->
        <div class="btn-group btn-group-sm ms-2" role="group">
          <button
            v-for="type in chartTypes"
            :key="type.value"
            type="button"
            class="btn"
            :class="chartType === type.value ? 'btn-primary' : 'btn-outline-primary'"
            :title="type.description"
            @click="setChartType(type.value)"
          >
            <i :class="type.icon"></i>
            {{ type.label }}
          </button>
        </div>

        <!-- Refresh Button -->
        <button
          :disabled="isLoading"
          class="btn btn-sm btn-outline-secondary ms-2"
          title="Refresh data"
          @click="loadData"
        >
          <i class="fas" :class="isLoading ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
        </button>
      </div>
    </template>

    <div class="vulnerability-timeseries-content">
      <!-- Loading State -->
      <div v-if="isLoading" class="chart-loading">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading vulnerability trends...</p>
        </div>
      </div>

      <!-- Error State -->
      <div v-else-if="error" class="alert alert-danger">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ error }}
        <button class="btn btn-sm btn-outline-danger ms-2" @click="loadData">
          Retry
        </button>
      </div>

      <!-- No Data State -->
      <div v-else-if="!hasData" class="chart-no-data">
        <div class="text-center py-5">
          <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No Vulnerability Data</h5>
          <p class="text-muted">
            No vulnerability scans found for the selected time period.
            <span v-if="componentId">Upload SBOMs to this component to see vulnerability trends.</span>
            <span v-else>Teams with vulnerability scanning will see trends here.</span>
          </p>
        </div>
      </div>

      <!-- Chart Display -->
      <div v-else class="chart-container">
        <!-- Summary Stats -->
        <div class="summary-stats mb-4">
          <div class="row">
            <div class="col-md-3">
              <div class="stat-box">
                <div class="stat-value">{{ summary.total_scans }}</div>
                <div class="stat-label">Total Scans</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-box">
                <div class="stat-value">{{ summary.total_vulnerabilities }}</div>
                <div class="stat-label">Vulnerabilities</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-box">
                <div class="stat-value">{{ summary.severity_totals.critical + summary.severity_totals.high }}</div>
                <div class="stat-label">Critical + High</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-box">
                <div class="stat-value">{{ selectedDays }}</div>
                <div class="stat-label">Days</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart Component -->
        <div class="chart-wrapper">
          <div class="chart-interaction-hint">
            <i class="fas fa-mouse-pointer me-1"></i>
            Click on chart data points to drill down and see specific SBOMs and releases
          </div>
          <div class="chart-canvas-container">
            <Line
              v-if="chartType === 'timeline'"
              :key="`timeline-${chartKey}`"
              :data="timelineChartData"
              :options="timelineChartOptions"
              @click="handleTimelineClick"
            />
            <Bar
              v-else-if="chartType === 'severity'"
              :key="`severity-${chartKey}`"
              :data="severityChartData"
              :options="severityChartOptions"
              @click="handleSeverityClick"
            />
            <Doughnut
              v-else-if="chartType === 'providers'"
              :key="`providers-${chartKey}`"
              :data="providerChartData"
              :options="providerChartOptions"
              @click="handleProviderClick"
            />
          </div>
        </div>

        <!-- Recent SBOM Scans Summary -->
        <div v-if="hasData && recentScans.length > 0" class="recent-scans-section mt-4">
          <div class="section-header">
            <h6 class="section-title">
              <i class="fas fa-clock me-2"></i>
              Recent SBOM Scans ({{ recentScans.length }})
            </h6>
            <button class="btn btn-sm btn-outline-primary" @click="loadAllScans">
              View All Scans
            </button>
          </div>

          <div class="recent-scans-list">
            <div
              v-for="scan in recentScans.slice(0, 5)"
              :key="scan.id"
              class="recent-scan-item"
              @click="navigateToSbom(scan.sbom_id)"
            >
              <div class="scan-info">
                <div class="scan-name">
                  <i class="fas fa-file-code me-2"></i>
                  {{ scan.sbom_name }}
                  <span v-if="scan.sbom_version" class="version-badge">{{ scan.sbom_version }}</span>
                  <span class="component-name">{{ scan.component_name }}</span>
                </div>
                <div class="scan-meta">
                  <span class="provider-badge" :class="scan.provider">
                    {{ formatProviderName(scan.provider) }}
                  </span>
                  <span class="scan-date">{{ formatDate(scan.scan_date) }}</span>
                </div>
              </div>
              <div class="scan-vulns">
                <div class="vuln-summary">
                  <span class="total-count">{{ scan.total_vulnerabilities }}</span>
                  <span class="vuln-label">vulnerabilities</span>
                </div>
                <div class="severity-badges">
                  <span v-if="scan.critical_vulnerabilities > 0" class="severity-badge critical">
                    {{ scan.critical_vulnerabilities }} Critical
                  </span>
                  <span v-if="scan.high_vulnerabilities > 0" class="severity-badge high">
                    {{ scan.high_vulnerabilities }} High
                  </span>
                  <span v-if="scan.medium_vulnerabilities > 0" class="severity-badge medium">
                    {{ scan.medium_vulnerabilities }} Medium
                  </span>
                  <span v-if="scan.low_vulnerabilities > 0" class="severity-badge low">
                    {{ scan.low_vulnerabilities }} Low
                  </span>
                </div>
              </div>
              <div class="scan-action">
                <i class="fas fa-arrow-right"></i>
              </div>
            </div>
          </div>

          <div v-if="recentScans.length > 5" class="show-more-scans">
            <button class="btn btn-outline-secondary btn-sm" @click="showAllRecentScans">
              Show All {{ recentScans.length }} Recent Scans
            </button>
          </div>
        </div>

        <!-- Drill-down Details -->
        <div v-if="drillDownData" class="drill-down-section mt-4">
          <div class="drill-down-header">
            <h6 class="fw-bold mb-3">
              <i class="fas fa-search-plus me-2"></i>
              {{ drillDownTitle }}
              <button class="btn btn-sm btn-outline-secondary ms-2" @click="closeDrillDown">
                <i class="fas fa-times"></i>
              </button>
            </h6>
          </div>

          <div class="drill-down-content">
            <!-- Components with Vulnerabilities -->
            <div v-if="drillDownData.components && drillDownData.components.length > 0" class="components-breakdown">
              <h6 class="section-title">
                Components with Vulnerabilities ({{ drillDownData.components.length }})
                <small class="text-muted ms-2">Click to view details or expand to see specific vulnerabilities</small>
              </h6>
              <div class="components-list">
                <div
                  v-for="component in drillDownData.components"
                  :key="component.id"
                  class="component-item expandable"
                >
                  <div class="component-header" @click="navigateToComponent(component.id)">
                    <div class="component-info">
                      <div class="component-name">
                        <i class="fas fa-cube me-2"></i>
                        {{ component.name }}
                      </div>
                      <div class="component-meta">
                        {{ component.sbom_count }} SBOM{{ component.sbom_count !== 1 ? 's' : '' }}
                      </div>
                    </div>
                    <div class="component-vulns">
                      <span class="vuln-count">{{ component.vulnerability_count }}</span>
                      <span class="vuln-label">vulnerabilities</span>
                      <div class="severity-breakdown">
                        <span v-if="component.severities.critical > 0" class="severity-badge critical">
                          {{ component.severities.critical }} Critical
                        </span>
                        <span v-if="component.severities.high > 0" class="severity-badge high">
                          {{ component.severities.high }} High
                        </span>
                        <span v-if="component.severities.medium > 0" class="severity-badge medium">
                          {{ component.severities.medium }} Medium
                        </span>
                        <span v-if="component.severities.low > 0" class="severity-badge low">
                          {{ component.severities.low }} Low
                        </span>
                      </div>
                    </div>
                    <div class="component-actions">
                      <button
                        class="btn btn-sm btn-outline-primary me-2"
                        title="Show vulnerabilities in this component"
                        @click.stop="toggleComponentVulnerabilities(component.id)"
                      >
                        <i class="fas fa-list"></i>
                        Show Vulnerabilities
                      </button>
                      <div class="component-action">
                        <i class="fas fa-arrow-right"></i>
                      </div>
                    </div>
                  </div>

                  <!-- Expandable vulnerability list for this component -->
                  <div
                    v-if="expandedComponents.has(component.id)"
                    class="component-vulnerabilities mt-3"
                  >
                    <div class="vulnerabilities-in-component">
                      <h6 class="component-vulns-title">
                        <i class="fas fa-shield-alt me-2"></i>
                        Vulnerabilities in {{ component.name }}
                      </h6>
                      <div
                        v-if="getVulnerabilitiesForComponent(component.id).length > 0"
                        class="vulnerability-list-for-component"
                      >
                        <div
                          v-for="vuln in getVulnerabilitiesForComponent(component.id)"
                          :key="vuln.id"
                          class="vulnerability-item-detailed"
                        >
                          <div class="vuln-header">
                            <div class="vuln-id-section">
                              <a
                                :href="`https://osv.dev/vulnerability/${vuln.id}`"
                                target="_blank"
                                class="vuln-id-link"
                              >
                                {{ vuln.id }}
                                <i class="fas fa-external-link-alt ms-1"></i>
                              </a>
                              <span
                                class="severity-badge"
                                :class="vuln.severity.toLowerCase()"
                              >
                                {{ vuln.severity }}
                              </span>
                            </div>
                          </div>
                          <div class="vuln-summary">
                            {{ vuln.summary || 'No summary available' }}
                          </div>
                          <div v-if="vuln.packages && vuln.packages.length > 0" class="affected-packages">
                            <small class="text-muted">Affected packages:</small>
                            <div class="package-list">
                              <span
                                v-for="pkg in vuln.packages.slice(0, 3)"
                                :key="`${pkg.name}-${pkg.version}`"
                                class="package-badge"
                              >
                                {{ pkg.name }}@{{ pkg.version }}
                              </span>
                              <span v-if="vuln.packages.length > 3" class="more-packages">
                                +{{ vuln.packages.length - 3 }} more
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div v-else class="no-vulnerabilities">
                        <i class="fas fa-shield-check text-success me-2"></i>
                        No vulnerabilities found matching current filters
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SBOMs with Vulnerabilities -->
            <div v-if="drillDownData.sboms && drillDownData.sboms.length > 0" class="sboms-breakdown mt-4">
              <h6 class="section-title">SBOMs with Vulnerabilities</h6>
              <div class="sboms-list">
                <div
                  v-for="sbom in drillDownData.sboms"
                  :key="sbom.id"
                  class="sbom-item"
                  @click="navigateToSbom(sbom.id)"
                >
                  <div class="sbom-info">
                    <div class="sbom-name">
                      <i class="fas fa-file-code me-2"></i>
                      {{ sbom.name }}
                    </div>
                    <div class="sbom-meta">
                      <span class="format-badge">{{ sbom.format }} {{ sbom.format_version }}</span>
                      <span class="scan-date">Last scan: {{ formatDate(sbom.last_scan_date) }}</span>
                    </div>
                  </div>
                  <div class="sbom-vulns">
                    <span class="vuln-count">{{ sbom.vulnerability_count }}</span>
                    <span class="vuln-label">vulnerabilities</span>
                    <div class="severity-breakdown">
                      <span v-if="sbom.severities.critical > 0" class="severity-badge critical">
                        {{ sbom.severities.critical }} Critical
                      </span>
                      <span v-if="sbom.severities.high > 0" class="severity-badge high">
                        {{ sbom.severities.high }} High
                      </span>
                      <span v-if="sbom.severities.medium > 0" class="severity-badge medium">
                        {{ sbom.severities.medium }} Medium
                      </span>
                      <span v-if="sbom.severities.low > 0" class="severity-badge low">
                        {{ sbom.severities.low }} Low
                      </span>
                    </div>
                  </div>
                  <div class="sbom-action">
                    <i class="fas fa-arrow-right"></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Vulnerabilities -->
            <div v-if="drillDownData.vulnerabilities && drillDownData.vulnerabilities.length > 0" class="vulnerabilities-breakdown mt-4">
              <h6 class="section-title">Top Vulnerabilities ({{ drillDownData.vulnerabilities.length }})</h6>
              <div class="vulnerabilities-list">
                <div
                  v-for="vuln in drillDownData.vulnerabilities.slice(0, 10)"
                  :key="vuln.id"
                  class="vulnerability-item"
                  @click="openVulnerabilityDetails(vuln)"
                >
                  <div class="vuln-info">
                    <div class="vuln-id">
                      <i class="fas fa-shield-alt me-2"></i>
                      {{ vuln.id }}
                    </div>
                    <div class="vuln-summary">{{ vuln.summary || 'No summary available' }}</div>
                  </div>
                  <div class="vuln-details">
                    <span class="severity-badge" :class="vuln.severity.toLowerCase()">
                      {{ vuln.severity }}
                    </span>
                    <span class="affected-count">{{ vuln.affected_components }} component{{ vuln.affected_components !== 1 ? 's' : '' }}</span>
                  </div>
                  <div class="vuln-action">
                    <i class="fas fa-external-link-alt"></i>
                  </div>
                </div>
              </div>
              <div v-if="drillDownData.vulnerabilities.length > 10" class="show-more-vulns">
                <button class="btn btn-outline-primary btn-sm" @click="showAllVulnerabilities">
                  Show All {{ drillDownData.vulnerabilities.length }} Vulnerabilities
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Severity Legend -->
        <div v-if="chartType === 'timeline' || chartType === 'severity'" class="severity-legend mt-3">
          <small class="text-muted fw-bold d-block mb-2">Severity Breakdown:</small>
          <div class="severity-items">
            <div
              v-for="(count, severity) in summary.severity_totals"
              v-show="count > 0"
              :key="severity"
              class="severity-item"
            >
              <span class="severity-indicator" :class="`severity-${severity}`"></span>
              <span class="severity-name">{{ formatSeverityName(severity) }}:</span>
              <span class="severity-count">{{ count }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </StandardCard>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch } from 'vue'
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler
} from 'chart.js'
import { Line, Bar, Doughnut } from 'vue-chartjs'
import StandardCard from '../../../core/js/components/StandardCard.vue'

// Register Chart.js components
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler
)

interface TimeSeriesData {
  date: string
  total_vulnerabilities: number
  scans_count: number
  severities: {
    critical: number
    high: number
    medium: number
    low: number
    info: number
  }
  providers: Record<string, { scans: number; vulnerabilities: number }>
}

interface VulnerabilityItem {
  id: string
  severity: string
  summary?: string
  affected_components?: number
  external_url?: string
  packages?: Array<{
    name: string
    version: string
  }>
}

interface ComponentItem {
  id: string
  name: string
  sbom_count: number
  vulnerability_count: number
  severities: {
    critical: number
    high: number
    medium: number
    low: number
    info: number
  }
}

interface SbomItem {
  id: string
  name: string
  format: string
  format_version: string
  component_name: string
  vulnerability_count: number
  severities: {
    critical: number
    high: number
    medium: number
    low: number
    info: number
  }
  last_scan_date: string
}

interface DrillDownData {
  components?: ComponentItem[]
  sboms?: SbomItem[]
  vulnerabilities?: VulnerabilityItem[]
}

interface ChartTooltipContext {
  label: string
  dataIndex: number
}

interface ProductData {
  id: string
  name: string
  description: string
  releases: Array<{
    id: string
    name: string
    description: string
    is_latest: boolean
    is_prerelease: boolean
    created_at: string
  }>
}

interface RecentScanItem {
  id: string
  sbom_id: string
  sbom_name: string
  sbom_version?: string
  component_name: string
  total_vulnerabilities: number
  critical_vulnerabilities: number
  high_vulnerabilities: number
  medium_vulnerabilities: number
  low_vulnerabilities: number
  scan_date: string
  provider: string
  format: string
  format_version: string
  last_scan_date: string
  severities: {
    critical: number
    high: number
    medium: number
    low: number
    info: number
  }
}

interface Summary {
  total_scans: number
  total_vulnerabilities: number
  severity_totals: {
    critical: number
    high: number
    medium: number
    low: number
    info: number
  }
  provider_summary: Record<string, { scans: number; vulnerabilities: number }>
  date_range: {
    start: string
    end: string
    days: number
  }
}

interface TimeSeriesResponse {
  time_series: TimeSeriesData[]
  summary: Summary
}

const props = defineProps<{
  teamKey: string
  componentId?: string
  defaultDays?: number
  showProductFilter?: boolean
}>()

type ChartType = 'timeline' | 'severity' | 'providers'

// Reactive state
const data = ref<TimeSeriesResponse | null>(null)
const isLoading = ref(false)
const error = ref<string | null>(null)
const selectedDays = ref(props.defaultDays || 30)
const chartType = ref<ChartType>('timeline')
const chartKey = ref(0) // Force chart re-render

// Product/Release filtering state
const productsData = ref<ProductData[]>([])
const selectedProductId = ref<string>('')
const selectedReleaseId = ref<string>('')
const isLoadingProducts = ref(false)

// Recent scans state
const recentScans = ref<RecentScanItem[]>([])

// Drill-down state
const drillDownData = ref<DrillDownData | null>(null)
const drillDownTitle = ref<string>('')
const expandedComponents = ref<Set<string>>(new Set())

// Configuration
const timeRanges = [
  { days: 7, label: '7D' },
  { days: 14, label: '2W' },
  { days: 30, label: '1M' },
  { days: 90, label: '3M' },
  { days: 180, label: '6M' }
]

const chartTypes: Array<{
  value: ChartType
  label: string
  icon: string
  description: string
}> = [
  {
    value: 'timeline',
    label: 'Timeline',
    icon: 'fas fa-chart-line',
    description: 'Vulnerability trends over time'
  },
  {
    value: 'severity',
    label: 'Severity',
    icon: 'fas fa-chart-bar',
    description: 'Breakdown by severity levels'
  },
  {
    value: 'providers',
    label: 'Providers',
    icon: 'fas fa-chart-pie',
    description: 'Breakdown by scanning providers'
  }
]

// Color schemes
const severityColors = {
  critical: '#dc3545',
  high: '#fd7e14',
  medium: '#ffc107',
  low: '#198754',
  info: '#0dcaf0'
}

const providerColors = {
  osv: '#4285f4',
  dependency_track: '#10b981'
}

// Computed properties
const hasData = computed(() => {
  return data.value && data.value.time_series.length > 0 && data.value.summary.total_scans > 0
})

const summary = computed(() => {
  return data.value?.summary || {
    total_scans: 0,
    total_vulnerabilities: 0,
    severity_totals: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },
    provider_summary: {},
    date_range: { start: '', end: '', days: 0 }
  }
})

// Get available releases for selected product
const availableReleases = computed(() => {
  if (!selectedProductId.value) return []

  const selectedProduct = productsData.value.find(p => p.id === selectedProductId.value)
  return selectedProduct?.releases || []
})

// Chart data
const timelineChartData = computed(() => {
  if (!hasData.value) return { labels: [], datasets: [] }

  const timeSeries = data.value!.time_series
  const labels = timeSeries.map(item => formatDateLabel(item.date))

  return {
    labels,
    datasets: [
      {
        label: 'Critical',
        data: timeSeries.map(item => item.severities.critical),
        borderColor: severityColors.critical,
        backgroundColor: severityColors.critical + '20',
        fill: true,
        tension: 0.1
      },
      {
        label: 'High',
        data: timeSeries.map(item => item.severities.high),
        borderColor: severityColors.high,
        backgroundColor: severityColors.high + '20',
        fill: true,
        tension: 0.1
      },
      {
        label: 'Medium',
        data: timeSeries.map(item => item.severities.medium),
        borderColor: severityColors.medium,
        backgroundColor: severityColors.medium + '20',
        fill: true,
        tension: 0.1
      },
      {
        label: 'Low',
        data: timeSeries.map(item => item.severities.low),
        borderColor: severityColors.low,
        backgroundColor: severityColors.low + '20',
        fill: true,
        tension: 0.1
      }
    ]
  }
})

const severityChartData = computed(() => {
  if (!hasData.value) return { labels: [], datasets: [] }

  const severities = summary.value.severity_totals
  const nonZeroSeverities = Object.entries(severities).filter(([, count]) => count > 0)

  return {
    labels: nonZeroSeverities.map(([severity]) => formatSeverityName(severity)),
    datasets: [{
      label: 'Vulnerabilities',
      data: nonZeroSeverities.map(([, count]) => count),
      backgroundColor: nonZeroSeverities.map(([severity]) => severityColors[severity as keyof typeof severityColors]),
      borderColor: nonZeroSeverities.map(([severity]) => severityColors[severity as keyof typeof severityColors]),
      borderWidth: 1
    }]
  }
})

const providerChartData = computed(() => {
  if (!hasData.value) return { labels: [], datasets: [] }

  const providers = summary.value.provider_summary
  const providerEntries = Object.entries(providers).filter(([, stats]) => stats.vulnerabilities > 0)

  return {
    labels: providerEntries.map(([provider]) => formatProviderName(provider)),
    datasets: [{
      label: 'Vulnerabilities',
      data: providerEntries.map(([, stats]) => stats.vulnerabilities),
      backgroundColor: providerEntries.map(([provider]) =>
        providerColors[provider as keyof typeof providerColors] || '#6c757d'
      ),
      borderWidth: 2,
      borderColor: '#ffffff'
    }]
  }
})

// Chart options
const timelineChartOptions = computed(() => ({
  responsive: true,
  maintainAspectRatio: false,
  aspectRatio: 2,
  plugins: {
    title: {
      display: true,
      text: 'Vulnerability Trends Over Time'
    },
    legend: {
      display: true,
      position: 'top' as const
    },
    tooltip: {
      mode: 'index' as const,
      intersect: false,
      callbacks: {
        title: (context: ChartTooltipContext[]) => `Date: ${context[0].label}`,
        afterBody: (context: ChartTooltipContext[]) => {
          const dataIndex = context[0].dataIndex
          const dayData = data.value!.time_series[dataIndex]
          return `Total Scans: ${dayData.scans_count}`
        }
      }
    }
  },
  scales: {
    x: {
      display: true,
      title: {
        display: true,
        text: 'Date'
      }
    },
    y: {
      display: true,
      title: {
        display: true,
        text: 'Vulnerabilities'
      },
      beginAtZero: true
    }
  },
  interaction: {
    mode: 'nearest' as const,
    axis: 'x' as const,
    intersect: false
  },
  onClick: handleTimelineClick
}))

const severityChartOptions = computed(() => ({
  responsive: true,
  maintainAspectRatio: false,
  aspectRatio: 2,
  plugins: {
    title: {
      display: true,
      text: 'Vulnerabilities by Severity'
    },
    legend: {
      display: false
    }
  },
  scales: {
    y: {
      beginAtZero: true,
      title: {
        display: true,
        text: 'Count'
      }
    }
  },
  onClick: handleSeverityClick
}))

const providerChartOptions = computed(() => ({
  responsive: true,
  maintainAspectRatio: false,
  aspectRatio: 1.5,
  plugins: {
    title: {
      display: true,
      text: 'Vulnerabilities by Provider'
    },
    legend: {
      display: true,
      position: 'right' as const
    }
  },
  onClick: handleProviderClick
}))

// Methods
const loadData = async (): Promise<void> => {
  isLoading.value = true
  error.value = null

  try {
    const params = new URLSearchParams({
      days: selectedDays.value.toString()
    })

    if (props.componentId) {
      params.append('component_id', props.componentId)
      // For component views, only show vulnerabilities from the latest SBOM
      params.append('latest_sbom_only', 'true')
    }

    // Add product/release filtering for dashboard views
    if (selectedProductId.value) {
      params.append('product_id', selectedProductId.value)
    }

    if (selectedReleaseId.value) {
      params.append('release_id', selectedReleaseId.value)
    }

    const response = await fetch(
      `/api/v1/vulnerability-scanning/teams/${props.teamKey}/vulnerability-timeseries?${params}`
    )

    if (!response.ok) {
      throw new Error(`Failed to load data: ${response.status}`)
    }

    data.value = await response.json()
    forceChartRefresh()

  } catch (err) {
    error.value = err instanceof Error ? err.message : 'Failed to load vulnerability trends'
  } finally {
    isLoading.value = false
  }
}

const setTimeRange = (days: number): void => {
  if (selectedDays.value !== days) {
    selectedDays.value = days
    loadData()
  }
}

const setChartType = (type: ChartType): void => {
  chartType.value = type
  forceChartRefresh()
}

const forceChartRefresh = (): void => {
  chartKey.value += 1
}

const formatDateLabel = (dateStr: string): string => {
  const date = new Date(dateStr)
  if (selectedDays.value <= 14) {
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
  } else if (selectedDays.value <= 90) {
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
  } else {
    return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })
  }
}

const formatSeverityName = (severity: string): string => {
  return severity.charAt(0).toUpperCase() + severity.slice(1)
}

const formatProviderName = (provider: string): string => {
  switch (provider) {
    case 'osv':
      return 'OSV'
    case 'dependency_track':
      return 'Dependency Track'
    default:
      return provider
  }
}

// Drill-down methods
const handleTimelineClick = async (event: unknown): Promise<void> => {
  const chartEvent = event as { chart?: { tooltip?: { dataPoints?: Array<{ dataIndex: number }> } } }
  if (!chartEvent?.chart?.tooltip?.dataPoints?.length) return

  const dataPoint = chartEvent.chart.tooltip.dataPoints[0]
  const dateIndex = dataPoint.dataIndex
  const selectedDate = data.value!.time_series[dateIndex].date

  drillDownTitle.value = `Vulnerabilities on ${formatDateLabel(selectedDate)}`
  await loadDrillDownData('date', selectedDate)
}

const handleSeverityClick = async (event: unknown): Promise<void> => {
  const chartEvent = event as { chart?: { tooltip?: { dataPoints?: Array<{ dataIndex: number }> } } }
  if (!chartEvent?.chart?.tooltip?.dataPoints?.length) return

  const dataPoint = chartEvent.chart.tooltip.dataPoints[0]
  const severityIndex = dataPoint.dataIndex
  const severityEntries = Object.entries(summary.value.severity_totals).filter(([, count]) => count > 0)
  const severity = severityEntries[severityIndex]?.[0]

  if (severity) {
    drillDownTitle.value = `${formatSeverityName(severity)} Severity Vulnerabilities`
    await loadDrillDownData('severity', severity)
  }
}

const handleProviderClick = async (event: unknown): Promise<void> => {
  const chartEvent = event as { chart?: { tooltip?: { dataPoints?: Array<{ dataIndex: number }> } } }
  if (!chartEvent?.chart?.tooltip?.dataPoints?.length) return

  const dataPoint = chartEvent.chart.tooltip.dataPoints[0]
  const providerIndex = dataPoint.dataIndex
  const providers = Object.keys(summary.value.provider_summary).filter(provider =>
    summary.value.provider_summary[provider].vulnerabilities > 0
  )
  const provider = providers[providerIndex]

  if (provider) {
    drillDownTitle.value = `${formatProviderName(provider)} Vulnerabilities`
    await loadDrillDownData('provider', provider)
  }
}

const loadDrillDownData = async (filterType: string, filterValue: string): Promise<void> => {
  try {
    const params = new URLSearchParams({
      days: selectedDays.value.toString(),
      filter_type: filterType,
      filter_value: filterValue
    })

    if (props.componentId) {
      params.append('component_id', props.componentId)
      // For component views, only show vulnerabilities from the latest SBOM
      params.append('latest_sbom_only', 'true')
    }

    // Add product/release filtering for dashboard views
    if (selectedProductId.value) {
      params.append('product_id', selectedProductId.value)
    }

    if (selectedReleaseId.value) {
      params.append('release_id', selectedReleaseId.value)
    }

    const response = await fetch(
      `/api/v1/vulnerability-scanning/teams/${props.teamKey}/vulnerability-drill-down?${params}`
    )

    if (!response.ok) {
      throw new Error(`Failed to load drill-down data: ${response.status}`)
    }

    drillDownData.value = await response.json() as DrillDownData
  } catch (err) {
    console.error('Failed to load drill-down data:', err)
    drillDownData.value = {
      components: [],
      sboms: [],
      vulnerabilities: []
    }
  }
}

const closeDrillDown = (): void => {
  drillDownData.value = null
  drillDownTitle.value = ''
}

const navigateToComponent = (componentId: string): void => {
  window.location.href = `/component/${componentId}/`
}

const navigateToSbom = (sbomId: string): void => {
  window.location.href = `/sbom/${sbomId}/`
}

const openVulnerabilityDetails = (vulnerability: VulnerabilityItem): void => {
  // Open vulnerability details in a new tab/window
  if (vulnerability.external_url) {
    window.open(vulnerability.external_url, '_blank')
  } else if (vulnerability.id.startsWith('CVE-')) {
    window.open(`https://cve.mitre.org/cgi-bin/cvename.cgi?name=${vulnerability.id}`, '_blank')
  } else if (vulnerability.id.startsWith('GHSA-')) {
    window.open(`https://github.com/advisories/${vulnerability.id}`, '_blank')
  }
}

const showAllVulnerabilities = (): void => {
  // Navigate to a dedicated vulnerabilities page with current filters
  const params = new URLSearchParams({
    days: selectedDays.value.toString()
  })

  if (props.componentId) {
    params.append('component_id', props.componentId)
  }

  window.location.href = `/workspace/${props.teamKey}/vulnerabilities?${params}`
}

const formatDate = (dateStr: string): string => {
  try {
    const date = new Date(dateStr)
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    })
  } catch {
    return dateStr
  }
}

// Recent scans methods
const loadRecentScans = async (): Promise<void> => {
  try {
    const params = new URLSearchParams({
      days: selectedDays.value.toString()
    })

    if (props.componentId) {
      params.append('component_id', props.componentId)
      // For component views, only show vulnerabilities from the latest SBOM
      params.append('latest_sbom_only', 'true')
    }

    // Add product/release filtering for dashboard views
    if (selectedProductId.value) {
      params.append('product_id', selectedProductId.value)
    }

    if (selectedReleaseId.value) {
      params.append('release_id', selectedReleaseId.value)
    }

    const response = await fetch(
      `/api/v1/vulnerability-scanning/teams/${props.teamKey}/vulnerability-stats?${params}`
    )

    if (response.ok) {
      const statsData = await response.json()
      recentScans.value = statsData.recent_results || []
    }
  } catch (err) {
    console.error('Failed to load recent scans:', err)
    recentScans.value = []
  }
}

const loadAllScans = (): void => {
  // Navigate to a dedicated scans page
  const params = new URLSearchParams({
    days: selectedDays.value.toString()
  })

  if (props.componentId) {
    params.append('component_id', props.componentId)
  }

  window.location.href = `/workspace/${props.teamKey}/vulnerability-scans?${params}`
}

const showAllRecentScans = (): void => {
  // Show all recent scans in a drill-down view
  drillDownTitle.value = `All Recent Scans (${recentScans.value.length})`
  drillDownData.value = {
    components: [],
    sboms: recentScans.value.map(scan => ({
      id: scan.sbom_id,
      name: `${scan.sbom_name}${scan.sbom_version ? ` ${scan.sbom_version}` : ''}`,
      component_name: scan.component_name,
      vulnerability_count: scan.total_vulnerabilities,
      severities: {
        critical: scan.critical_vulnerabilities,
        high: scan.high_vulnerabilities,
        medium: scan.medium_vulnerabilities,
        low: scan.low_vulnerabilities,
        info: 0
      },
      last_scan_date: scan.scan_date,
      format: 'SBOM',
      format_version: scan.sbom_version || ''
    })),
    vulnerabilities: []
  }
}

// Lifecycle
onMounted(() => {
  loadData()
  loadRecentScans()
  loadProductsReleases()
})

// Watch for component changes
watch(() => props.componentId, () => {
  loadData()
  loadRecentScans()
})

// Load products and releases for filtering
const loadProductsReleases = async (): Promise<void> => {
  if (!props.showProductFilter) return

  isLoadingProducts.value = true

  try {
    const response = await fetch(
      `/api/v1/vulnerability-scanning/teams/${props.teamKey}/products-releases`
    )

    if (response.ok) {
      const data = await response.json()
      productsData.value = data.products || []
    }
  } catch (err) {
    console.error('Failed to load products and releases:', err)
    productsData.value = []
  } finally {
    isLoadingProducts.value = false
  }
}

// Handle filter changes
const handleProductChange = (productId: string): void => {
  selectedProductId.value = productId
  selectedReleaseId.value = '' // Reset release when product changes
  loadData()
  loadRecentScans()
}

const handleReleaseChange = (releaseId: string): void => {
  selectedReleaseId.value = releaseId
  loadData()
  loadRecentScans()
}

const clearFilters = (): void => {
  selectedProductId.value = ''
  selectedReleaseId.value = ''
  loadData()
  loadRecentScans()
}

// Component drill-down methods
const toggleComponentVulnerabilities = (componentId: string): void => {
  if (expandedComponents.value.has(componentId)) {
    expandedComponents.value.delete(componentId)
  } else {
    expandedComponents.value.add(componentId)
  }
}

const getVulnerabilitiesForComponent = (componentId: string): VulnerabilityItem[] => {
  void componentId  // Mark as intentionally unused
  if (!drillDownData.value?.vulnerabilities) return []

  // Filter vulnerabilities that affect this specific component
  // This is a simplified approach - in a real implementation, you would need
  // component-specific vulnerability data from the API
  return (drillDownData.value.vulnerabilities as VulnerabilityItem[]).filter(() => {
    // For now, show all vulnerabilities for any component
    // In a real implementation, you would filter based on which
    // vulnerabilities actually affect the specific componentId
    return true
  })
}

// Watch for time range changes
watch(selectedDays, () => {
  loadRecentScans()
})
</script>

<style scoped>
.vulnerability-timeseries-content {
  min-height: 400px;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.filter-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: #6c757d;
  margin-bottom: 0;
}

/* Enhanced component drill-down styles */
.component-item.expandable {
  border: 1px solid #e9ecef;
  border-radius: 8px;
  background: #fff;
  margin-bottom: 0.75rem;
}

.component-header {
  padding: 1rem;
  cursor: pointer;
  transition: background-color 0.2s;
}

.component-header:hover {
  background-color: #f8f9fa;
}

.component-actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.component-vulnerabilities {
  border-top: 1px solid #e9ecef;
  background-color: #f8f9fa;
  padding: 1rem;
}

.component-vulns-title {
  font-size: 0.9rem;
  font-weight: 600;
  color: #495057;
  margin-bottom: 0.75rem;
}

.vulnerability-item-detailed {
  background: #fff;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
}

.vuln-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.5rem;
}

.vuln-id-section {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.vuln-id-link {
  font-weight: 600;
  text-decoration: none;
  color: #007bff;
}

.vuln-id-link:hover {
  text-decoration: underline;
}

.vuln-summary {
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 0.5rem;
  line-height: 1.4;
}

.affected-packages {
  margin-top: 0.5rem;
}

.package-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
  margin-top: 0.25rem;
}

.package-badge {
  background-color: #e9ecef;
  color: #495057;
  padding: 0.125rem 0.375rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
}

.more-packages {
  color: #6c757d;
  font-size: 0.75rem;
  font-style: italic;
}

.no-vulnerabilities {
  text-align: center;
  padding: 1rem;
  color: #6c757d;
  font-style: italic;
}

.chart-loading,
.chart-no-data {
  min-height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chart-container {
  padding: 1rem 0;
  position: relative;
  z-index: 0;
}

.chart-wrapper {
  position: relative;
  height: 400px;
  margin: 1rem 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.chart-wrapper > * {
  flex-shrink: 0;
}

/* Chart canvas container */
.chart-canvas-container {
  flex: 1;
  min-height: 0;
  position: relative;
  overflow: hidden;
}

/* Ensure Chart.js canvas doesn't overflow */
.chart-wrapper canvas {
  max-width: 100% !important;
  max-height: 350px !important;
  position: relative !important;
}

.summary-stats {
  background: linear-gradient(135deg, #f8fafc, #e2e8f0);
  border-radius: 8px;
  padding: 1rem;
}

.stat-box {
  text-align: center;
  padding: 0.75rem;
  background: white;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1f2937;
  line-height: 1;
}

.stat-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-top: 0.25rem;
}

.severity-legend {
  padding: 1rem;
  background: #f8fafc;
  border-radius: 6px;
}

.severity-items {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
}

.severity-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
}

.severity-indicator {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.severity-critical {
  background-color: #dc3545;
}

.severity-high {
  background-color: #fd7e14;
}

.severity-medium {
  background-color: #ffc107;
}

.severity-low {
  background-color: #198754;
}

.severity-info {
  background-color: #0dcaf0;
}

.severity-name {
  font-weight: 600;
  color: #374151;
}

.severity-count {
  color: #6b7280;
}

/* Chart interaction hint */
.chart-interaction-hint {
  text-align: center;
  font-size: 0.875rem;
  color: #6b7280;
  margin-bottom: 1rem;
  padding: 0.5rem;
  background: #f3f4f6;
  border-radius: 6px;
  border-left: 3px solid #3b82f6;
}

/* Recent scans section */
.recent-scans-section {
  background: linear-gradient(135deg, #f8fafc, #e2e8f0);
  border: 1px solid #d1d5db;
  border-radius: 12px;
  padding: 1.5rem;
  margin-top: 2rem;
  clear: both;
  position: relative;
  z-index: 1;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #d1d5db;
}

.recent-scans-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.recent-scan-item {
  display: flex;
  align-items: center;
  padding: 1rem;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.recent-scan-item:hover {
  border-color: #3b82f6;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
  transform: translateY(-1px);
}

.scan-info {
  flex: 1;
  min-width: 0;
}

.scan-name {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 0.25rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.version-badge {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  padding: 0.125rem 0.5rem;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-left: 0.5rem;
  margin-right: 0.5rem;
  font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
  box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
}

.component-name {
  font-weight: normal;
  color: #6b7280;
  font-size: 0.875rem;
}

.scan-meta {
  font-size: 0.875rem;
  color: #6b7280;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.provider-badge {
  background: #e5e7eb;
  color: #374151;
  padding: 0.125rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
}

.provider-badge.osv {
  background: #dbeafe;
  color: #1e40af;
}

.provider-badge.dependency_track {
  background: #dcfce7;
  color: #166534;
}

.scan-vulns {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.5rem;
  margin-right: 1rem;
}

.vuln-summary {
  display: flex;
  align-items: baseline;
  gap: 0.25rem;
}

.total-count {
  font-size: 1.125rem;
  font-weight: 700;
  color: #1f2937;
}

.vuln-label {
  font-size: 0.875rem;
  color: #6b7280;
}

.severity-badges {
  display: flex;
  gap: 0.25rem;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.scan-action {
  color: #6b7280;
  margin-left: 0.5rem;
}

.show-more-scans {
  text-align: center;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #e5e7eb;
}

/* Drill-down Styles */
.drill-down-section {
  background: linear-gradient(135deg, #f8fafc, #e2e8f0);
  border: 1px solid #d1d5db;
  border-radius: 12px;
  padding: 1.5rem;
  margin-top: 1.5rem;
}

.drill-down-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #d1d5db;
}

.section-title {
  font-size: 1rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
}

.components-list,
.sboms-list,
.vulnerabilities-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.component-item,
.sbom-item,
.vulnerability-item {
  display: flex;
  align-items: center;
  padding: 1rem;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.component-item:hover,
.sbom-item:hover,
.vulnerability-item:hover {
  border-color: #3b82f6;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
  transform: translateY(-1px);
}

.component-info,
.sbom-info,
.vuln-info {
  flex: 1;
  min-width: 0;
}

.component-name,
.sbom-name,
.vuln-id {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 0.25rem;
  display: flex;
  align-items: center;
}

.component-meta,
.sbom-meta {
  font-size: 0.875rem;
  color: #6b7280;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.vuln-summary {
  font-size: 0.875rem;
  color: #6b7280;
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.format-badge {
  background: #e5e7eb;
  color: #374151;
  padding: 0.125rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
}

.scan-date {
  font-size: 0.75rem;
  color: #9ca3af;
}

.component-vulns,
.sbom-vulns,
.vuln-details {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.5rem;
  margin-right: 1rem;
}

.vuln-count {
  font-size: 1.25rem;
  font-weight: 700;
  color: #dc2626;
}

.vuln-label {
  font-size: 0.75rem;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.025em;
}

.affected-count {
  font-size: 0.75rem;
  color: #6b7280;
}

.severity-breakdown {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
  justify-content: flex-end;
}

.severity-badge {
  padding: 0.125rem 0.375rem;
  border-radius: 4px;
  font-size: 0.625rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.025em;
}

.severity-badge.critical {
  background: #fecaca;
  color: #991b1b;
}

.severity-badge.high {
  background: #fed7aa;
  color: #9a3412;
}

.severity-badge.medium {
  background: #fef3c7;
  color: #92400e;
}

.severity-badge.low {
  background: #dcfce7;
  color: #166534;
}

.component-action,
.sbom-action,
.vuln-action {
  color: #6b7280;
  font-size: 0.875rem;
}

.show-more-vulns {
  text-align: center;
  margin-top: 1rem;
}

@media (max-width: 768px) {
  .chart-wrapper {
    height: 300px;
  }

  .summary-stats .row > div {
    margin-bottom: 0.75rem;
  }

  .severity-items {
    flex-direction: column;
    gap: 0.5rem;
  }

  .drill-down-section {
    padding: 1rem;
  }

  .component-item,
  .sbom-item,
  .vulnerability-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .component-vulns,
  .sbom-vulns,
  .vuln-details {
    align-items: flex-start;
    margin-right: 0;
  }

  .severity-breakdown {
    justify-content: flex-start;
  }
}
</style>